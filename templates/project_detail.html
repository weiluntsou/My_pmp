{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/cft_projects" class="btn">← 專案列表</a>
</div>

<div class="card tech-border">
    <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
            <h2 style="margin: 0; color: var(--accent-cyan);">{{ project.name }}</h2>
            <div style="color: var(--text-secondary); margin-top: 5px;">{{ project.cft_unit }} | {{ project.year }}
            </div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 2em; font-weight: bold; color: var(--accent-purple);">{{ project.progress }}%</div>
            <div style="font-size: 0.8em; color: var(--text-secondary);">States: <span id="projectStatus">{{
                    project.status }}</span></div>
            {% if project.status != 'Maintenance' and project.status != 'Deployed' %}
            <div style="display: flex; gap: 5px; justify-content: flex-end; margin-top: 10px;">
                <a href="/projects/{{ project.id }}/planning" class="btn"
                    style="display: inline-block; padding: 4px 10px; font-size: 0.8em;">編輯週計畫</a>
                <button onclick="openCloseModal()" class="btn"
                    style="padding: 4px 10px; font-size: 0.8em; color: var(--accent-cyan); border-color: var(--accent-cyan);">Close
                    Project / 結案</button>
            </div>
            {% else %}
            <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">
                {% if project.closure_date %}Closed: {{ project.closure_date }}{% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    <p style="margin-top: 20px; color: var(--text-primary);">{{ project.description or 'No description provided.' }}</p>
</div>

<!-- Project Timeline -->
<div class="card" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Project Timeline & Roadmap</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div class="btn-group" style="margin-right: 15px;">
                <a href="?view_mode=week&focus_date={{ gantt.focus_date }}"
                    class="btn btn-sm {{ 'btn-primary' if gantt.view_mode == 'week' else 'btn-outline-secondary' }}">Week</a>
                <a href="?view_mode=month&focus_date={{ gantt.focus_date }}"
                    class="btn btn-sm {{ 'btn-primary' if gantt.view_mode == 'month' else 'btn-outline-secondary' }}">Month</a>
                <a href="?view_mode=quarter&focus_date={{ gantt.focus_date }}"
                    class="btn btn-sm {{ 'btn-primary' if gantt.view_mode == 'quarter' else 'btn-outline-secondary' }}">Quarter</a>
            </div>
            <button class="btn"
                style="border: 1px solid var(--accent-purple); color: var(--accent-purple); font-size: 0.9em; padding: 5px 10px;"
                onclick="addNextWeek()">+ Add Week</button>
        </div>
    </div>
    {% include "projects/gantt.html" %}
</div>

<!-- Add Progress Modal -->
<div id="progressModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; justify-content: center; align-items: center;">
    <div class="card" style="width: 400px; max-width: 90%;">
        <h3>Update Weekly Progress</h3>
        <div id="pDateRange"
            style="color: var(--accent-cyan); font-size: 0.9em; margin-bottom: 10px; text-align: center;"></div>
        <form id="progressForm" onsubmit="submitProgress(event)">
            <div class="grid-2" style="margin-bottom: 15px;">
                <input type="number" name="year" id="pYear" value="2025" placeholder="Year">
                <input type="number" name="week" id="pWeek" placeholder="Week #" required readonly>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color:var(--accent-purple);">Actual Progress (%) (Project Total Calc)</label>
                <input type="number" id="pActualProgress" placeholder="e.g 100" class="btn"
                    style="width:100%; margin-top:5px; text-align:left;" step="1" max="100" min="0">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color:var(--accent-purple);">Planned Description</label>
                <input type="text" id="pPlannedDesc" placeholder="Kickoff..." class="btn"
                    style="width:100%; margin-top:5px; text-align:left;" readonly>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="color:var(--accent-cyan);">Actual Description (Reporting)</label>
                <textarea id="pActualDesc" placeholder="Enter actual progress details here involved..." class="btn"
                    style="width:100%; min-height:80px; margin-top:5px; text-align:left;"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="color:var(--accent-pink);">Time Spent (Hours)</label>
                <input type="number" id="pActualHours" placeholder="e.g 8.5" class="btn" step="0.5"
                    style="width:100%; margin-top:5px; text-align:left;">
            </div>

            <div style="display: flex; justify-content: space-between; gap: 10px;">
                <div style="display: flex; gap: 5px;">
                    <button type="button" class="btn" onclick="extendProject()"
                        style="border: 1px solid var(--accent-purple); color: var(--accent-purple); font-size: 0.8em; padding: 5px 10px;">
                        + 追加
                    </button>
                    <button type="button" class="btn" onclick="reduceProject()"
                        style="border: 1px solid var(--accent-pink); color: var(--accent-pink); font-size: 0.8em; padding: 5px 10px;">
                        - 縮減
                    </button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn" onclick="closeProgressModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Maintenance Logs Section (Visible only if Maintenance or Deployed) -->
{% if project.status == 'Maintenance' or project.status == 'Deployed' %}
<div class="card" style="margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Maintenance Log / 維運記錄</h3>
        <button class="btn btn-primary" onclick="openMaintenanceModal()">+ Add Log</button>
    </div>

    <div style="margin-top: 15px; max-height: 400px; overflow-y: auto;">
        {% if project.maintenance_logs %}
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Content</th>
                    <th>Hours</th>
                </tr>
            </thead>
            <tbody>
                {% for log in project.maintenance_logs %}
                <tr>
                    <td>{{ log.log_date }}</td>
                    <td>
                        <span
                            style="color: {% if log.log_type == 'Incident' %}var(--accent-pink){% else %}var(--accent-cyan){% endif %}">
                            {{ log.log_type }}
                        </span>
                    </td>
                    <td>{{ log.content }}</td>
                    <td>{{ log.hours_spent }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; color: var(--text-secondary);">No maintenance logs yet.</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Close Project Modal -->
<div id="closeProjectModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; justify-content: center; align-items: center;">
    <div class="card" style="width: 400px;">
        <h3>Close Project / 專案結案</h3>
        <p>Please enter the closure meeting date to proceed.</p>
        <form onsubmit="submitCloseProject(event)">
            <input type="date" id="closeDate" class="btn" style="width: 100%; text-align: left; margin-bottom: 20px;"
                required>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="btn"
                    onclick="document.getElementById('closeProjectModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary">Close Project</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Maintenance Log Modal -->
<div id="maintenanceModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; justify-content: center; align-items: center;">
    <div class="card" style="width: 400px;">
        <h3>New Maintenance Log</h3>
        <form onsubmit="submitMaintenanceLog(event)">
            <div class="grid-2">
                <input type="date" id="mDate" class="btn" style="width: 100%; margin-bottom: 10px;" required>
                <select id="mType" class="btn" style="width: 100%; margin-bottom: 10px;" required>
                    <option value="Routine">Regular/Routine (定期維運)</option>
                    <option value="Incident">Incident/Error (突發異常)</option>
                </select>
            </div>
            <div style="margin-bottom: 10px;">
                <input type="number" id="mHours" class="btn" style="width: 100%; text-align: left;"
                    placeholder="Hours Spent (e.g. 2.0)" step="0.5" required>
            </div>
            <textarea id="mContent" class="btn" style="width: 100%; min-height: 100px; text-align: left;"
                placeholder="Content..." required></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn"
                    onclick="document.getElementById('maintenanceModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Log</button>
            </div>
        </form>
    </div>
</div>

<!-- Project History Log -->
<div class="card" style="margin-top: 20px;">
    <h3>{{ project.name }} : Project History</h3>
    <div style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
        {% for log in project.logs %}
        <div style="border-left: 2px solid var(--accent-cyan); padding-left: 10px;">
            <div style="font-size: 0.8em; color: var(--text-secondary);">{{ log.created_at.strftime('%Y-%m-%d
                %H:%M') }}
            </div>
            <div style="color: var(--text-primary);">{{ log.content }}</div>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const projectId = {{ project.id }};
    const projectDuration = {{ project.duration_weeks or 12 }};
    const weeklyData = {{ weekly_data | tojson }} || [];

    // Prepare Chart Data
    const labels = weeklyData.map(d => `Week ${d.week_number}`);
    const plannedData = weeklyData.map(d => d.planned_progress);
    const actualData = weeklyData.map(d => d.actual_progress);

    // Custom Gantt Chart Logic
    document.addEventListener('DOMContentLoaded', renderGantt);

    function renderGantt() {
        try {
            const container = document.getElementById('ganttContainer');
            if (!container) return; // Should not happen with new template

            // This function is largely obsolete if we use the new Gantt template.
            // But let's leave it safe.
        } catch (e) {
            console.error(e);
        }

        // --- Fix for Template Variable Injection ---
        // New Logic: Always 52 Weeks for the Project Year
        const projectYear = {{ project.year or 2025 }};
    const totalWeeks = 52;
    }

    function openProgressModal(data = null, type = 'planned') {
        const modal = document.getElementById('progressModal');
        modal.style.display = 'flex';

        if (data) {
            document.getElementById('pYear').value = data.year;
            document.getElementById('pWeek').value = data.week_number;

            // Simple Date Logic for Display
            const simple = new Date(data.year, 0, 1 + (data.week_number - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());

            const weekEnd = new Date(ISOweekStart);
            weekEnd.setDate(ISOweekStart.getDate() + 6);

            const fmt = (d) => d.toLocaleDateString();
            document.getElementById('pDateRange').innerText = `${fmt(ISOweekStart)} - ${fmt(weekEnd)}`;

            const pDescInput = document.getElementById('pPlannedDesc');
            const aDescInput = document.getElementById('pActualDesc');
            if (pDescInput) pDescInput.value = data.planned_description || '';
            if (aDescInput) aDescInput.value = data.actual_description || '';
            const pActualProg = document.getElementById('pActualProgress');
            if (pActualProg) pActualProg.value = data.actual_progress || 0;
        } else {
            const today = new Date();
            document.getElementById('pYear').value = today.getFullYear();
            document.getElementById('pWeek').value = '';
            document.getElementById('pPlannedDesc').value = '';
            document.getElementById('pActualDesc').value = '';
            document.getElementById('pActualHours').value = '';
            document.getElementById('pActualProgress').value = '';
        }
        if (data && data.actual_hours) {
            document.getElementById('pActualHours').value = data.actual_hours;
        }
    }

    function closeProgressModal() {
        document.getElementById('progressModal').style.display = 'none';
    }

    async function submitProgress(e) {
        e.preventDefault();
        const year = document.getElementById('pYear').value;
        const week = document.getElementById('pWeek').value;
        const plannedDesc = document.getElementById('pPlannedDesc').value;
        const actualDesc = document.getElementById('pActualDesc').value;

        try {
            const response = await fetch(`/api/projects/${projectId}/weekly_progress`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    year: parseInt(year),
                    week_number: parseInt(week),
                    planned_description: plannedDesc,
                    actual_description: actualDesc,
                    actual_hours: parseFloat(document.getElementById('pActualHours').value || 0),
                    actual_progress: parseInt(document.getElementById('pActualProgress').value || 0)
                })
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to update progress');
            }
        } catch (err) {
            console.error(err);
            alert('Error updating progress');
        }
    }

    function openCloseModal() {
        document.getElementById('closeProjectModal').style.display = 'flex';
        document.getElementById('closeDate').valueAsDate = new Date();
    }

    async function submitCloseProject(e) {
        e.preventDefault();
        const date = document.getElementById('closeDate').value;
        try {
            const res = await fetch(`/api/projects/${projectId}/close?closure_date=${date}`, { method: 'POST' });
            if (res.ok) {
                location.reload();
            } else {
                alert('Failed to close project');
            }
        } catch (e) { console.error(e); alert('Error'); }
    }

    function openMaintenanceModal() {
        document.getElementById('maintenanceModal').style.display = 'flex';
        document.getElementById('mDate').valueAsDate = new Date();
    }

    async function submitMaintenanceLog(e) {
        e.preventDefault();
        try {
            const body = {
                log_date: document.getElementById('mDate').value,
                log_type: document.getElementById('mType').value,
                content: document.getElementById('mContent').value,
                hours_spent: parseFloat(document.getElementById('mHours').value || 0)
            };
            const res = await fetch(`/api/projects/${projectId}/maintenance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (res.ok) location.reload();
            else alert('Failed');
        } catch (e) { alert('Error'); }
    }

    function addNextWeek() {
        // Find max week currently in data or Gantt
        let maxW = 0;
        if (weeklyData && weeklyData.length > 0) {
            maxW = Math.max(...weeklyData.map(d => d.week_number));
        } else {
            maxW = projectDuration;
        }

        // Open modal for next week
        openProgressModal({
            year: {{ project.year or 2025 }},
    week_number: maxW + 1,
        planned_description: '',
            actual_description: '',
                actual_hours: 0,
                    actual_progress: 0
        }, 'actual'); 
    }

    async function extendProject() {
        const currentWeekParam = document.getElementById('pWeek').value;
        const currentWeek = parseInt(currentWeekParam);

        if (!currentWeek) {
            alert('Cannot determine current week context.');
            return;
        }

        if (!confirm(`Are you sure you want to INSERT a new week AFTER Week ${currentWeek}?`)) return;

        try {
            const res = await fetch(`/api/projects/${projectId}/extend?after_week=${currentWeek}`, { method: 'POST' });
            if (res.ok) {
                location.reload();
            } else {
                alert('Failed to extend project');
            }
        } catch (e) {
            console.error(e);
            alert('Error extending project');
        }
    }

    async function reduceProject() {
        const currentWeekParam = document.getElementById('pWeek').value;
        const currentWeek = parseInt(currentWeekParam);
        if (!currentWeek) {
            alert('Cannot determine current week context.');
            return;
        }

        if (!confirm(`Are you sure you want to DELETE Week ${currentWeek} and shift subsequent weeks?`)) return;
        try {
            const res = await fetch(`/api/projects/${projectId}/reduce?target_week=${currentWeek}`, { method: 'POST' });
            if (res.ok) {
                location.reload();
            } else {
                alert('Failed to reduce project duration');
            }
        } catch (e) {
            console.error(e);
            alert('Error reducing project duration');
        }
    }
</script>
{% endblock %}