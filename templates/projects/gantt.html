<!-- Toolbar -->
<div class="d-flex justify-content-between align-items-center mb-3"
    style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
    <div class="btn-group">
        <button class="btn btn-outline-secondary btn-sm" onclick="shiftDate(-1)"> &lt; Prev </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="shiftDate(1)"> Next &gt; </button>
    </div>

    <div style="font-weight: bold; color: var(--accent-cyan); text-transform: uppercase; font-size: 0.9em;">
        {{ gantt.headers[0].label }} - {{ gantt.headers[-1].label }}
    </div>
</div>

<!-- Gantt Scroll Container -->
<div style="overflow-x: auto; position: relative; border: 1px solid var(--border-color); border-radius: 6px;">
    <!-- Min-Width Wrapper to ensure alignment -->
    <div style="min-width: 1000px; position: relative;">

        <!-- Headers -->
        <div
            style="display: grid; grid-template-columns: {{ gantt.grid_template }}; gap: 1px; background: var(--border-color);">
            {% for h in gantt.headers %}
            <div
                style="background: rgba(13, 17, 23, 0.9); padding: 8px; text-align: center; font-size: 0.8rem; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                {{ h.label }}
            </div>
            {% endfor %}
        </div>

        <!-- Grid Lines Background Layer -->
        <div
            style="display: grid; grid-template-columns: {{ gantt.grid_template }}; position: absolute; top: 38px; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;">
            {% for h in gantt.headers %}
            <div style="border-right: 1px solid var(--border-color); opacity: 0.3;"></div>
            {% endfor %}
        </div>

        <!-- Bars Layer -->
        <div style="position: relative; z-index: 1; padding-top: 10px;">

            <!-- SECTION 1: Planned Progress -->
            <div style="margin-bottom: 30px;">
                <h4
                    style="color: var(--accent-purple); margin: 0 0 10px 10px; border-left: 3px solid var(--accent-purple); padding-left: 10px;">
                    Planned Progress (規劃進度)</h4>
                {% for bar in gantt.bars %}
                <div
                    style="display: grid; grid-template-columns: {{ gantt.grid_template }}; margin-bottom: 5px; height: 30px; align-items: center; border-bottom: 1px solid rgba(48, 54, 61, 0.3);">
                    <div style="
                        grid-column: {{ bar.grid_start }} / span {{ bar.grid_span }};
                        background: rgba(168, 85, 247, 0.1);
                        border: 1px solid var(--accent-purple);
                        border-radius: 4px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        padding: 0 10px;
                        color: var(--accent-purple);
                        font-size: 0.75rem;
                        white-space: nowrap;
                        overflow: hidden;
                        cursor: pointer;
                    " title="Planned: {{ bar.name }}" onclick="if(typeof openProgressModal === 'function') openProgressModal({
                        planned_description: '{{ bar.name | replace('\'', '\\\'') }}',
                        year: 2025, week_number: 1 
                    }, 'planned'); else alert('Planned: {{ bar.name | replace('\'', '\\\'') }}');">
                        {{ bar.name }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- SECTION 2: Actual Progress -->
            <div>
                <h4
                    style="color: var(--accent-cyan); margin: 0 0 10px 10px; border-left: 3px solid var(--accent-cyan); padding-left: 10px;">
                    Actual Progress (實際進度)</h4>
                {% for bar in gantt.bars %}
                <!-- Row Container -->
                <div
                    style="display: grid; grid-template-columns: {{ gantt.grid_template }}; margin-bottom: 5px; height: 30px; align-items: center; border-bottom: 1px solid rgba(48, 54, 61, 0.3); position: relative;">

                    <!-- Background Track for context -->
                    <div style="grid-column: 1 / -1; height: 100%; background: rgba(0,0,0,0.2);"></div>

                    {% for act in bar.actuals %}
                    {% set is_overdue = (act.grid_start + act.grid_span) > (bar.grid_start + bar.grid_span) %}
                    <div class="actual-bar {% if is_overdue %}flash-red{% endif %}" style="
                        grid-column: {{ act.grid_start }} / span {{ act.grid_span }};
                        background: {% if act.has_content %}var(--accent-cyan){% else %}transparent{% endif %};
                        border: {% if act.has_content %}none{% else %}1px dashed var(--accent-cyan){% endif %};
                        height: 24px;
                        min-width: 10px; /* Ensure small/empty bars are visible */
                        border-radius: 3px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 100; /* High z-index */
                        position: relative;
                        box-shadow: {% if act.has_content %}0 0 5px var(--accent-cyan){% endif %};
                        color: #000;
                        font-size: 0.7rem;
                        font-weight: bold;
                        pointer-events: auto;
                        " title="Week {{ act.week }}" data-year="{{ act.year }}" data-week="{{ act.week }}"
                        data-actual-progress="{{ act.progress }}" data-actual-desc="{{ act.description or '' }}"
                        data-actual-hours="{{ act.actual_hours }}" data-planned-progress="{{ act.planned_progress }}"
                        data-planned-desc="{{ act.planned_description or '' }}">
                        {% if act.has_content %}
                        {{ act.week }}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>

            {% if not gantt.bars %}
            <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                No tasks visible in this time range.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function shiftDate(direction) {
        const urlParams = new URLSearchParams(window.location.search);
        const currentMode = urlParams.get('view_mode') || 'week';
        let currentDateStr = urlParams.get('focus_date');

        // Default to server provided current if missing, or today
        if (!currentDateStr) currentDateStr = new Date().toISOString().split('T')[0];

        let date = new Date(currentDateStr);

        if (currentMode === 'week') {
            date.setDate(date.getDate() + (direction * 12 * 7));
        } else if (currentMode === 'month') {
            date.setMonth(date.getMonth() + (direction * 12));
        } else if (currentMode === 'quarter') {
            date.setMonth(date.getMonth() + (direction * 24));
        }

        const newDate = date.toISOString().split('T')[0];
        urlParams.set('focus_date', newDate);
        window.location.search = urlParams.toString();
    }

    // Event Delegation for Actual Bars
    document.addEventListener('click', function (e) {
        const bar = e.target.closest('.actual-bar');
        if (bar && typeof openProgressModal === 'function') {
            const d = bar.dataset;
            openProgressModal({
                year: parseInt(d.year),
                week_number: parseInt(d.week),
                actual_progress: parseInt(d.actualProgress || 0),
                actual_description: d.actualDesc,
                actual_hours: parseInt(d.actualHours || 0),
                planned_progress: parseInt(d.plannedProgress || 0),
                planned_description: d.plannedDesc
            }, 'actual');
        }
    });
</script>